<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Calorie Counter</title>

  <!-- React (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Tailwind (CDN for prototype/demo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#050505;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --muted2: rgba(255,255,255,0.52);
      --orange:#ff7a18;
      --orange2:#ff9a3d;
      --good:#35d07f;
      --warn:#ffcc66;
      --bad:#ff5b5b;
      --shadow: 0 14px 60px rgba(0,0,0,0.55);
    }
    html,body{height:100%; background:var(--bg); color:var(--text);}
    body{margin:0;}
    video{object-fit:cover;}
    *{-webkit-tap-highlight-color:transparent;}
    .safe-pt{padding-top:calc(env(safe-area-inset-top) + 12px);}
    .safe-pb{padding-bottom:calc(env(safe-area-inset-bottom) + 12px);}

    @keyframes glow {
      0%,100%{ box-shadow:0 0 0 rgba(255,122,24,0); }
      50%{ box-shadow:0 0 28px rgba(255,122,24,0.22); }
    }
    .glow{ animation:glow 2.2s ease-in-out infinite; }

    @keyframes pulseSoft {
      0%,100%{ opacity:.55; }
      50%{ opacity:.9; }
    }
    .pulseSoft{ animation:pulseSoft 1.4s ease-in-out infinite; }

    /* Bottom sheet */
    .sheet {
      transform: translateY(110%);
      transition: transform 220ms ease;
    }
    .sheet.open { transform: translateY(0%); }

    /* Thin scrollbar (if any content overflows) */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.06); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); border-radius: 999px; }

    /* Button press */
    .press:active{ transform: scale(0.98); }
  </style>
</head>

<body>
  <div id="root"></div>

  <script>
    const { useEffect, useMemo, useRef, useState } = React;

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function round(n){ return Math.round(Number(n) || 0); }

    function ratingColor(score){
      const s = Number(score) || 0;
      if (s >= 82) return "var(--good)";
      if (s >= 65) return "var(--warn)";
      return "var(--bad)";
    }

    function prettyConfidence(c){
      const v = clamp(Number(c) || 0, 0, 1);
      return `${Math.round(v * 100)}%`;
    }

    function macroBlend(total){
      const p = Number(total?.protein_g)||0;
      const c = Number(total?.carbs_g)||0;
      const f = Number(total?.fat_g)||0;
      const sum = p+c+f;
      if (!sum) return "—";
      const pr = p/sum, cr = c/sum, fr = f/sum;
      if (pr >= 0.35) return "Protein-forward";
      if (cr >= 0.55) return "Carb-forward";
      if (fr >= 0.40) return "Fat-forward";
      return "Balanced-ish";
    }

    async function analyzeFrameFromVideo(videoEl){
      const w = videoEl.videoWidth;
      const h = videoEl.videoHeight;
      if (!w || !h) return null;

      // Smaller payload => fewer 429s + faster
      const targetW = 512;
      const scale = targetW / w;
      const tw = Math.round(w * clamp(scale, 0.2, 1));
      const th = Math.round(h * clamp(scale, 0.2, 1));

      const canvas = document.createElement("canvas");
      canvas.width = tw;
      canvas.height = th;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(videoEl, 0, 0, tw, th);

      const base64 = canvas.toDataURL("image/jpeg", 0.6).split(",")[1];

      const res = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ imageBase64: base64 })
      });

      let data = null;
      try { data = await res.json(); } catch { data = { error: "Non-JSON response from server" }; }

      return { ok: res.ok, status: res.status, data };
    }

    function App(){
      const videoRef = useRef(null);
      const streamRef = useRef(null);

      // rate-limit control
      const inFlightRef = useRef(false);
      const lastCallRef = useRef(0);

      const [status, setStatus] = useState("idle"); // idle | starting | running | error
      const [busy, setBusy] = useState(false);

      const [sheetOpen, setSheetOpen] = useState(false);
      const [errorMsg, setErrorMsg] = useState("");

      const [result, setResult] = useState(null);

      const totals = useMemo(() => {
        const t = result?.total || {};
        return {
          kcal: Number(t.kcal) || 0,
          protein_g: Number(t.protein_g) || 0,
          carbs_g: Number(t.carbs_g) || 0,
          fat_g: Number(t.fat_g) || 0
        };
      }, [result]);

      const rating = useMemo(() => {
        const r = result?.rating || {};
        return {
          score: Number(r.score) || 0,
          label: (r.label || "—").toString()
        };
      }, [result]);

      const items = useMemo(() => Array.isArray(result?.items) ? result.items : [], [result]);
      const suggestions = useMemo(() => Array.isArray(result?.suggestions) ? result.suggestions : [], [result]);
      const conf = useMemo(() => clamp(Number(result?.confidence) || 0, 0, 1), [result]);

      const headline = useMemo(() => {
        if (items.length === 0) return "Detected meal";
        const top = (items[0]?.name || "").toString().trim();
        return top || "Detected meal";
      }, [items]);

      async function startCamera(){
        setErrorMsg("");
        setResult(null);
        setSheetOpen(false);
        setStatus("starting");

        try{
          if (streamRef.current){
            streamRef.current.getTracks().forEach(t => t.stop());
            streamRef.current = null;
          }

          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: "environment" },
              width: { ideal: 1280 },
              height: { ideal: 720 }
            },
            audio: false
          });

          streamRef.current = stream;

          const video = videoRef.current;
          video.srcObject = stream;
          video.playsInline = true;
          video.muted = true;

          await video.play();

          inFlightRef.current = false;
          lastCallRef.current = 0;

          setStatus("running");
        }catch(e){
          setStatus("error");
          setErrorMsg(e?.message || "Camera permission denied / not available.");
        }
      }

      function stopCamera(){
        if (streamRef.current){
          streamRef.current.getTracks().forEach(t => t.stop());
          streamRef.current = null;
        }
        setStatus("idle");
        setBusy(false);
        setResult(null);
        setSheetOpen(false);
        setErrorMsg("");
        inFlightRef.current = false;
      }

      function overlayTap(e){
        if (e.target?.dataset?.overlay === "1") setSheetOpen(false);
      }

      useEffect(() => {
        let rafId = null;

        async function loop(){
          rafId = requestAnimationFrame(loop);

          if (status !== "running") return;
          if (!videoRef.current) return;

          // STOP calls while the details sheet is open
          if (sheetOpen) return;

          // Throttle to avoid 429
          const now = performance.now();
          const MIN_INTERVAL_MS = 6000; // 1 call / 6s
          if (now - lastCallRef.current < MIN_INTERVAL_MS) return;

          if (inFlightRef.current) return;

          inFlightRef.current = true;
          lastCallRef.current = now;
          setBusy(true);

          try{
            const resp = await analyzeFrameFromVideo(videoRef.current);
            if (!resp) return;

            // Vercel function returns { error, status, raw } when OpenAI errors
            if (!resp.ok){
              const details = resp?.data?.details || resp?.data?.raw || "";
              const msg = resp?.data?.error || `API error (${resp.status})`;
              setErrorMsg(details ? `${msg}: ${String(details).slice(0, 220)}` : msg);

              // Backoff on 429 to stop repeated throttling
              if (resp.status === 429){
                lastCallRef.current = performance.now() + 15000; // wait 15s
              }
              return;
            }

            // Even if ok, the function might return a structured error JSON
            if (resp.data?.error){
              setErrorMsg(resp.data.error);
              if (resp.data?.raw_openai) {
                // keep it short for UI, but visible for debugging
                setErrorMsg(`${resp.data.error}: ${String(resp.data.raw_openai).slice(0, 220)}`);
              }
              return;
            }

            setErrorMsg("");
            setResult(resp.data);
          }catch(err){
            console.error(err);
            setErrorMsg("Network/API error");
          }finally{
            setBusy(false);
            inFlightRef.current = false;
          }
        }

        rafId = requestAnimationFrame(loop);
        return () => { if (rafId) cancelAnimationFrame(rafId); };
      }, [status, sheetOpen]);

      useEffect(() => () => stopCamera(), []);

      return (
        React.createElement("div", { className: "min-h-screen safe-pt safe-pb" },
          React.createElement("div", { className: "max-w-md mx-auto px-4" },

            // Header
            React.createElement("div", { className: "flex items-center justify-between mb-3" },
              React.createElement("div", null,
                React.createElement("div", { className: "text-sm text-white/70" }, "Calorie Counter"),
                React.createElement("div", { className: "text-xl font-semibold tracking-tight" },
                  React.createElement("span", { style: { color: "var(--orange)" } }, "Live"),
                  " Meal Scan"
                )
              ),
              status !== "running"
                ? React.createElement("button", {
                    onClick: startCamera,
                    className: "press glow px-4 py-2 rounded-2xl font-semibold text-black",
                    style: { background: "linear-gradient(135deg, var(--orange), var(--orange2))" }
                  }, "Check Calories")
                : React.createElement("button", {
                    onClick: stopCamera,
                    className: "press px-4 py-2 rounded-2xl font-semibold bg-white/10 border border-white/10 text-white"
                  }, "Stop")
            ),

            // Instruction card
            React.createElement("div", {
              className: "rounded-2xl p-4 mb-4",
              style: { background: "var(--card)", border: "1px solid var(--border)", boxShadow: "0 10px 35px rgba(0,0,0,0.35)" }
            },
              React.createElement("div", { className: "text-sm text-white/85" },
                "Point your camera at the meal. Calories update automatically."
              ),
              React.createElement("div", { className: "mt-2 text-xs text-white/55 space-y-1" },
                React.createElement("div", null, "• Ensure good lighting."),
                React.createElement("div", null, "• Keep the full plate in frame"),
                React.createElement("div", null, "• Estimates vary by portion size")
              ),
              errorMsg ? React.createElement("div", { className: "mt-3 text-sm text-red-300" }, errorMsg) : null
            ),

            // Camera frame
            React.createElement("div", {
              className: "relative overflow-hidden rounded-3xl border mb-4",
              style: { borderColor: "rgba(255,255,255,0.10)", background: "#000", aspectRatio: "3/4", boxShadow: "var(--shadow)" }
            },
              React.createElement("video", {
                ref: videoRef,
                className: "absolute inset-0 w-full h-full",
                playsInline: true,
                muted: true
              }),

              // Top chips
              React.createElement("div", { className: "absolute top-3 left-3 right-3 flex items-center justify-between gap-2" },
                React.createElement("div", {
                  className: "px-3 py-1.5 rounded-2xl text-xs border",
                  style: { background: "rgba(0,0,0,0.35)", borderColor: "rgba(255,255,255,0.12)" }
                },
                  status === "running" ? (busy ? "Analyzing…" : "Live Scan") : "Preview"
                ),
                React.createElement("div", {
                  className: "px-3 py-1.5 rounded-2xl text-xs border",
                  style: { background: "rgba(0,0,0,0.35)", borderColor: "rgba(255,122,24,0.30)", color: "var(--orange2)" }
                },
                  status === "running" ? "Analyzing Food" : "Tap Check Calories"
                )
              ),

              // Bottom overlay
              React.createElement("div", {
                className: "absolute inset-x-0 bottom-0 p-3",
                style: { background: "linear-gradient(to top, rgba(0,0,0,0.82), rgba(0,0,0,0))" }
              },

                !result
                  ? React.createElement("div", {
                      className: "rounded-2xl p-4 border",
                      style: { background: "rgba(0,0,0,0.35)", borderColor: "rgba(255,255,255,0.10)" }
                    },
                      React.createElement("div", { className: "text-sm text-white/85" },
                        status === "running"
                          ? React.createElement("span", { className: "pulseSoft" }, "Scanning meal…")
                          : "Ensure your food is clearly seen."
                      ),
                      React.createElement("div", { className: "mt-1 text-xs text-white/55" },
                        status === "running"
                          ? "Updates every few seconds to control cost and avoid rate limits."
                          : "Better lighting helps improve the accuracy."
                      )
                    )
                  : React.createElement("div", {
                      className: "rounded-2xl p-4 border",
                      style: { background: "rgba(0,0,0,0.40)", borderColor: "rgba(255,255,255,0.12)" }
                    },

                      React.createElement("div", { className: "flex items-start justify-between gap-3" },
                        React.createElement("div", null,
                          React.createElement("div", { className: "text-xs text-white/60" }, "Estimated total"),
                          React.createElement("div", { className: "text-3xl font-bold leading-none" },
                            React.createElement("span", { style: { color: "var(--orange)" } }, round(totals.kcal)),
                            React.createElement("span", { className: "text-base font-semibold text-white/80 ml-1" }, "kcal")
                          ),
                          React.createElement("div", { className: "mt-2 text-sm font-semibold" }, headline),
                          React.createElement("div", { className: "mt-1 text-xs text-white/60" },
                            `${prettyConfidence(conf)} confidence • live estimate`
                          )
                        ),

                        React.createElement("div", { className: "text-right" },
                          React.createElement("div", { className: "text-xs text-white/60" }, "Meal rating"),
                          React.createElement("div", {
                            className: "mt-1 inline-flex items-center gap-2 px-3 py-1.5 rounded-2xl border text-sm font-semibold",
                            style: { background: "rgba(255,255,255,0.06)", borderColor: "rgba(255,255,255,0.10)" }
                          },
                            React.createElement("span", {
                              className: "inline-block w-2 h-2 rounded-full",
                              style: { background: ratingColor(rating.score) }
                            }),
                            `${rating.label} • ${round(rating.score)}/100`
                          ),

                          React.createElement("button", {
                            onClick: () => setSheetOpen(true),
                            className: "press mt-3 w-full px-4 py-2 rounded-2xl font-semibold text-black",
                            style: { background: "linear-gradient(135deg, var(--orange), var(--orange2))" }
                          }, "More details")
                        )
                      ),

                      React.createElement("div", { className: "mt-3 flex flex-wrap gap-2 text-xs" },
                        React.createElement("span", {
                          className: "px-2.5 py-1 rounded-2xl border",
                          style: { background: "rgba(255,255,255,0.06)", borderColor: "rgba(255,255,255,0.10)" }
                        }, `${round(totals.protein_g)}g protein`),
                        React.createElement("span", {
                          className: "px-2.5 py-1 rounded-2xl border",
                          style: { background: "rgba(255,255,255,0.06)", borderColor: "rgba(255,255,255,0.10)" }
                        }, `${round(totals.carbs_g)}g carbs`),
                        React.createElement("span", {
                          className: "px-2.5 py-1 rounded-2xl border",
                          style: { background: "rgba(255,255,255,0.06)", borderColor: "rgba(255,255,255,0.10)" }
                        }, `${round(totals.fat_g)}g fat`),
                        React.createElement("span", {
                          className: "px-2.5 py-1 rounded-2xl border",
                          style: { background: "rgba(255,122,24,0.12)", borderColor: "rgba(255,122,24,0.25)", color: "var(--orange2)" }
                        }, macroBlend(totals))
                      )
                    )
              )
            ),

            React.createElement("div", { className: "text-xs text-white/45 mb-2" },
              "Tip: On iPhone, allow camera permission for the site. Estimates vary with portion size."
            )
          ),

          // Bottom sheet overlay (blocks background)
          React.createElement("div", {
            "data-overlay": "1",
            onClick: overlayTap,
            className: "fixed inset-0 z-50",
            style: { display: sheetOpen ? "block" : "none", background: "rgba(0,0,0,0.55)" }
          },
            React.createElement("div", { className: "absolute inset-x-0 bottom-0 sheet open" },
              React.createElement("div", {
                className: "rounded-t-3xl border px-4 pt-3 pb-4 max-h-[78vh] overflow-auto",
                style: { background: "rgba(10,10,10,0.98)", borderColor: "rgba(255,255,255,0.10)" }
              },

                // Sheet header
                React.createElement("div", { className: "flex items-center justify-between" },
                  React.createElement("div", null,
                    React.createElement("div", { className: "text-sm font-semibold" }, "Meal breakdown"),
                    React.createElement("div", { className: "text-xs text-white/55 mt-0.5" }, headline)
                  ),
                  React.createElement("button", {
                    onClick: () => setSheetOpen(false),
                    className: "press px-3 py-2 rounded-2xl bg-white/10 border border-white/10 text-sm"
                  }, "Close")
                ),

                // Summary tiles
                React.createElement("div", { className: "mt-3 grid grid-cols-2 gap-3" },
                  React.createElement("div", {
                    className: "rounded-2xl p-3 border",
                    style: { background: "var(--card)", borderColor: "rgba(255,255,255,0.10)" }
                  },
                    React.createElement("div", { className: "text-xs text-white/60" }, "Calories"),
                    React.createElement("div", { className: "text-2xl font-bold", style: { color: "var(--orange)" } },
                      round(totals.kcal), " kcal"
                    )
                  ),
                  React.createElement("div", {
                    className: "rounded-2xl p-3 border",
                    style: { background: "var(--card)", borderColor: "rgba(255,255,255,0.10)" }
                  },
                    React.createElement("div", { className: "text-xs text-white/60" }, "Confidence"),
                    React.createElement("div", { className: "text-2xl font-bold" }, prettyConfidence(conf))
                  ),
                  React.createElement("div", {
                    className: "rounded-2xl p-3 border",
                    style: { background: "var(--card)", borderColor: "rgba(255,255,255,0.10)" }
                  },
                    React.createElement("div", { className: "text-xs text-white/60" }, "Protein"),
                    React.createElement("div", { className: "text-xl font-semibold" }, round(totals.protein_g), " g")
                  ),
                  React.createElement("div", {
                    className: "rounded-2xl p-3 border",
                    style: { background: "var(--card)", borderColor: "rgba(255,255,255,0.10)" }
                  },
                    React.createElement("div", { className: "text-xs text-white/60" }, "Carbs"),
                    React.createElement("div", { className: "text-xl font-semibold" }, round(totals.carbs_g), " g")
                  ),
                  React.createElement("div", {
                    className: "rounded-2xl p-3 border",
                    style: { background: "var(--card)", borderColor: "rgba(255,255,255,0.10)" }
                  },
                    React.createElement("div", { className: "text-xs text-white/60" }, "Fat"),
                    React.createElement("div", { className: "text-xl font-semibold" }, round(totals.fat_g), " g")
                  ),
                  React.createElement("div", {
                    className: "rounded-2xl p-3 border",
                    style: { background: "var(--card)", borderColor: "rgba(255,255,255,0.10)" }
                  },
                    React.createElement("div", { className: "text-xs text-white/60" }, "Rating"),
                    React.createElement("div", { className: "text-xl font-semibold" }, round(rating.score), "/100")
                  )
                ),

                // Items list
                React.createElement("div", { className: "mt-4" },
                  React.createElement("div", { className: "text-sm font-semibold mb-2" }, "Detected items"),
                  items.length === 0
                    ? React.createElement("div", { className: "text-sm text-white/60" },
                        "No items parsed (try re-framing the meal)."
                      )
                    : React.createElement("div", { className: "space-y-2" },
                        items.slice(0, 8).map((it, i) => (
                          React.createElement("div", {
                            key: i,
                            className: "rounded-2xl p-3 border",
                            style: { background: "rgba(255,255,255,0.06)", borderColor: "rgba(255,255,255,0.10)" }
                          },
                            React.createElement("div", { className: "flex items-start justify-between gap-3" },
                              React.createElement("div", null,
                                React.createElement("div", { className: "text-sm font-semibold" }, (it.name || "Item").toString()),
                                React.createElement("div", { className: "text-xs text-white/55 mt-0.5" }, (it.portion || "").toString())
                              ),
                              React.createElement("div", { className: "text-sm font-semibold", style: { color: "var(--orange2)" } },
                                `${round(it.kcal)} kcal`
                              )
                            ),
                            React.createElement("div", { className: "mt-2 text-xs text-white/65" },
                              `${round(it.protein_g)}g P • ${round(it.carbs_g)}g C • ${round(it.fat_g)}g F`
                            )
                          )
                        ))
                      )
                ),

                // Suggestions
                React.createElement("div", { className: "mt-4" },
                  React.createElement("div", { className: "text-sm font-semibold mb-2" }, "Suggestions"),
                  suggestions.length === 0
                    ? React.createElement("div", { className: "text-sm text-white/60" }, "No suggestions returned.")
                    : React.createElement("div", { className: "space-y-2" },
                        suggestions.slice(0, 6).map((s, i) => (
                          React.createElement("div", {
                            key: i,
                            className: "rounded-2xl p-3 border",
                            style: { background: "rgba(255,255,255,0.06)", borderColor: "rgba(255,255,255,0.10)" }
                          },
                            React.createElement("div", { className: "text-xs", style: { color: "var(--orange2)" } },
                              (s.goal || "Suggestion").toString()
                            ),
                            React.createElement("div", { className: "text-sm text-white/85 mt-1" },
                              (s.add || "").toString()
                            )
                          )
                        ))
                      )
                ),

                React.createElement("div", { className: "mt-4 text-xs text-white/45" },
                  "Note: Estimates from an image can vary by portion size, ingredients, and cooking method."
                )
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
